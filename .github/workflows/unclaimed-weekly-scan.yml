name: 3B Unclaimed Weekly Scan
on:
  schedule:
    - cron: '0 22 * * 0'  # Sunday 10PM PST
  workflow_dispatch:
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Call Tracker
        run: |
          curl -X POST https://rkwdryneutgyqrnbuwaz.supabase.co/functions/v1/pg-tracker \
            -H "x-tracker-secret: ${{ secrets.TRACKER_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{}' > unclaimed.json
      
      - name: Summary
        run: |
          jq '.total_count, .by_state.NV // 0' unclaimed.json
          
      - name: Slack Alert (if NV > threshold)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
